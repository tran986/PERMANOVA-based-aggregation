---
title: "aim2_control"
output: html_document
date: "2025-02-22"
---

```{r setup, include=FALSE}
# Required packages
install.packages("vegan")
install.packages("boot")  # For confidence intervals

library(vegan)
library(boot)

# --------------------------- #
# Step 1: Calculate Sample Size
# --------------------------- #

# n=(Z^2*p(1-p))/E^2 : formula used to calculate for the sample size needed to reach confidence interval of 0.95, margin of error = 0.01, and expected Type I error = 0.05; with ES = 0, for make it faster, only bootstrap for 20 samples on 5 variables (genes)

calculate_sample_size <- function(alpha = 0.05, error_margin = 0.01, confidence = 0.95) {
  z_score <- qnorm(1 - (1 - confidence) / 2)  # Z for desired confidence
  p <- alpha  # Expected Type I error rate
  E <- error_margin
  n <- (z_score^2 * p * (1 - p)) / E^2
  return(ceiling(n))
}

# Example: Calculate for 95% confidence, 5% alpha, Â±1% margin
n_simulations <- calculate_sample_size(alpha = 0.05, error_margin = 0.01, confidence = 0.95)
cat("Required number of negative control simulations:", n_simulations, "\n")

#1825 simulations

# --------------------------- #
# Step 2: Generate Negative Control Data
# --------------------------- #

simulate_data <- function(n_samples = 20, n_variables = 5) {
  # Random data with no group differences
  data_matrix <- matrix(rnorm(n_samples * n_variables), nrow = n_samples, ncol = n_variables)
  metadata <- data.frame(group = sample(c("A", "B"), n_samples, replace = TRUE))
  return(list(data_matrix = data_matrix, metadata = metadata))
}

# --------------------------- #
# Step 3: Run PERMANOVA on Each Simulation
# --------------------------- #

run_permanova <- function(data_matrix, metadata) {
  dist_matrix <- vegdist(data_matrix, method = "euclidean")
  result <- adonis2(dist_matrix ~ group, data = metadata, permutations = 999)
  
  # Extract p-value, F-statistic, and R-squared
  p_value <- result$`Pr(>F)`[1]
  f_statistic <- result$F[1]
  r_squared <- result$R2[1]
  
  return(c(p_value, f_statistic, r_squared))
}

# --------------------------- #
# Step 4: Simulate and Store Results
# --------------------------- #

simulate_negative_controls <- function(n_simulations, n_samples = 20, n_variables = 5, alpha = 0.05) {
  p_values <- numeric(n_simulations)
  f_statistics <- numeric(n_simulations)
  r_squared_values <- numeric(n_simulations)
  
  for (i in 1:n_simulations) {
    sim <- simulate_data(n_samples, n_variables)
    results <- run_permanova(sim$data_matrix, sim$metadata)
    p_values[i] <- results[1]
    f_statistics[i] <- results[2]
    r_squared_values[i] <- results[3]
  }
  
  # Calculate Type I Error
  type_I_error <- mean(p_values < alpha)
  
  # Confidence Interval using bootstrapping
  ci <- boot.ci(boot(data = p_values, statistic = function(data, indices) {
    mean(data[indices] < alpha)
  }, R = 1000), type = "perc")
  
  return(list(p_values = p_values, 
              f_statistics = f_statistics, 
              r_squared_values = r_squared_values,
              type_I_error = type_I_error, 
              ci_lower = ci$percent[4], 
              ci_upper = ci$percent[5]))
}

# --------------------------- #
# Step 5: Run and Print Results
# --------------------------- #

set.seed(123)  # For reproducibility
results <- simulate_negative_controls(n_simulations = n_simulations)

cat("\nResults:\n")
cat("Type I Error Rate:", results$type_I_error, "\n")
cat("95% Confidence Interval:", results$ci_lower, "-", results$ci_upper, "\n")

# Optional: Visualize results
par(mfrow = c(1, 3))
hist(results$p_values, breaks = 30, main = "P-values", xlab = "p-value")
hist(results$f_statistics, breaks = 30, main = "F-statistics", xlab = "F-statistic")
hist(results$r_squared_values, breaks = 30, main = "R-squared values", xlab = "R-squared")

#-----------------------
#-----------------------Save Results to CSV
save_results <- function(results, filename = "permanova_results.csv") {
  # Combine results into a data frame
  df <- data.frame(
    p_value = results$p_values,
    f_statistic = results$f_statistics,
    r_squared = results$r_squared_values
  )
  
  # Write to CSV
  write.csv(df, file = filename, row.names = FALSE)
  
  # Save summary stats in a separate file
  summary_df <- data.frame(
    type_I_error = results$type_I_error,
    ci_lower = results$ci_lower,
    ci_upper = results$ci_upper
  )
  write.csv(summary_df, file = "permanova_summary.csv", row.names = FALSE)
  
  cat("\nResults saved to", filename, "and summary saved to permanova_summary.csv\n")
}

# --------------------------- #
# Step 6: Save Output
# --------------------------- #
save_results(results, filename = "negative_control_permanova_results.csv")



```

